@{
    Layout = "_Layout";
}

<main class="container">
    <form id="surveyForm">

        <div class="rating-labels">
            <span class="label-opcion uno">Muy malo (1)</span>
            <span class="label-opcion dos">Malo (2)</span>
            <span class="label-opcion tres">Regular (3)</span>
            <span class="label-opcion cuatro">Bueno (4)</span>
            <span class="label-opcion cinco">Excelente (5)</span>
        </div>

        <div class="questions-list" id="questionsContainer">
            <div class="question-item">

            </div>
        </div>
        <div class="form-buttons">
            <button type="submit" class="submit-button">Finalizar encuesta</button>
            <button type="button" class="cancel-button" onclick="cancelSurvey()">Cancelar</button>
        </div>

    </form>
</main>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const encuestaId = new URLSearchParams(window.location.search).get("id");
        const idRespuesta = localStorage.getItem("idRespuesta");
        const token = localStorage.getItem("token");

        if (!encuestaId || !idRespuesta || !token) {
            alert("Datos de sesión incompletos.");
            window.location.href = "/Users/Index";
            return;
        }

        await cargarPreguntas(encuestaId, token);

        document.getElementById("surveyForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            await enviarRespuestas(idRespuesta, token);
        });

        document.querySelector(".cancel-button").addEventListener("click", async () => {
            const confirmar = confirm("¿Cancelar la encuesta?");
            if (!confirmar) return;

            try {
                await fetch(`https://apiencuestase8.websitos256.com/api/respuestas/cancelar/${idRespuesta}`, {
                    method: "DELETE",
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                localStorage.removeItem("idRespuesta");
                window.location.href = "/Users/Index";
            } catch (err) {
                console.error(err);
                alert("Error al cancelar la encuesta.");
            }
        });
    });

    async function cargarPreguntas(encuestaId, token) {
        const container = document.getElementById("questionsContainer");
        container.innerHTML = "";

        try {
            const res = await fetch(`https://apiencuestase8.websitos256.com/api/encuestas/con-preguntas/${encuestaId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!res.ok) throw new Error("Error al obtener preguntas");

            const data = await res.json();
            const preguntas = data.preguntas;

            preguntas.forEach((pregunta, index) => {
                const questionDiv = document.createElement("div");
                questionDiv.classList.add("question-item");

                const label = document.createElement("label");
                label.classList.add("question-text");
                label.textContent = `${index + 1}. ${pregunta.descripcion}`;
                questionDiv.appendChild(label);

                const optionsDiv = document.createElement("div");
                optionsDiv.classList.add("rating-options");

                for (let i = 1; i <= 5; i++) {
                    const optionLabel = document.createElement("label");
                    const radio = document.createElement("input");

                    radio.type = "radio";
                    radio.name = `q${pregunta.id}`;
                    radio.value = i;
                    radio.required = true;

                    const span = document.createElement("span");
                    span.textContent = i;

                    optionLabel.appendChild(radio);
                    optionLabel.appendChild(span);
                    optionsDiv.appendChild(optionLabel);
                }

                questionDiv.appendChild(optionsDiv);
                container.appendChild(questionDiv);
            });
        } catch (err) {
            console.error(err);
            alert("No se pudieron cargar las preguntas.");
        }
    }

    async function enviarRespuestas(idRespuesta, token) {
        const respuestas = [];

        document.querySelectorAll(".question-item").forEach(div => {
            const idPregunta = div.querySelector("input[type='radio']").name.replace("q", "");
            const valor = div.querySelector("input[type='radio']:checked")?.value;

            if (!valor) return;

            respuestas.push({
                idRespuesta: parseInt(idRespuesta),
                idPregunta: parseInt(idPregunta),
                valorEvaluacion: parseInt(valor)
            });
        });

        if (respuestas.length === 0) {
            alert("Debe responder todas las preguntas.");
            return;
        }

        try {
            const res = await fetch("https://apiencuestase8.websitos256.com/api/respuestas/responderPreguntas", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify(respuestas)
            });

            if (!res.ok) throw new Error("Error al guardar respuestas.");

            alert("¡Gracias por responder!");
            localStorage.removeItem("idRespuesta");
            window.location.href = "/Users/Index"; // o a donde necesites redirigir
        } catch (err) {
            console.error(err);
            alert("Hubo un problema al enviar las respuestas.");
        }
    }
</script>
